<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarokka Reading</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Merriweather:wght@400;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Link to external style.css -->
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <!-- Preloader -->
    <div id="preloader">
        <div class="preloader-symbol"></div>
        <p class="text-white text-lg font-bold">Summoning the Fates...</p>
    </div>

    <!-- Main Game View -->
    <div id="main-game-view">
        <!-- Background Table with Parallax -->
        <div id="background-table" class="absolute inset-0 z-0"></div>

        <!-- Dust Motes Effect -->
        <div class="dust-motes"></div>

        <!-- Candle Light Source -->
        <div id="candle-light-source"></div>

        <!-- DM Interface Container (holds DM controls and DM Card Info Box) -->
        <div id="dm-interface-container">
            <!-- DM Control Panel -->
            <div id="dm-control-panel">
                <h2 class="font-bold text-white mb-2">DM Controls</h2>

                <div class="dm-controls">
                    <!-- Rigging controls -->
                    <div class="mb-3">
                        <h3 class="font-semibold text-white mb-1">Rig the Deck:</h3>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="flex items-center gap-1">
                                <label for="rig-tome" class="flex-shrink-0">Tome:</label>
                                <select id="rig-tome" data-position="tome" class="flex-grow"></select>
                            </div>
                            <div class="flex items-center gap-1">
                                <label for="rig-holySymbol" class="flex-shrink-0">Holy Symbol:</label>
                                <select id="rig-holySymbol" data-position="holySymbol" class="flex-grow"></select>
                            </div>
                            <div class="flex items-center gap-1">
                                <label for="rig-sunsword" class="flex-shrink-0">Sunsword:</label>
                                <select id="rig-sunsword" data-position="sunsword" class="flex-grow"></select>
                            </div>
                            <div class="flex items-center gap-1">
                                <label for="rig-ally" class="flex-shrink-0">Ally:</label>
                                <select id="rig-ally" data-position="ally" class="flex-grow"></select>
                            </div>
                            <div class="flex items-center gap-1">
                                <label for="rig-strahd" data-position="strahd" class="flex-shrink-0">Strahd:</label>
                                <select id="rig-strahd" data-position="strahd" class="flex-grow"></select>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <button id="randomize-all-btn"><i class="fas fa-dice mr-1"></i>Randomize All</button>
                    <button id="shuffle-deal-btn"><i class="fas fa-sync-alt mr-1"></i>Shuffle & Deal</button>
                    <button id="reveal-all-btn"><i class="fas fa-eye mr-1"></i>Reveal All</button>
                    <button id="hide-all-btn"><i class="fas fa-eye-slash mr-1"></i>Hide All</button>
                    <button id="print-handout-btn"><i class="fas fa-print mr-1"></i>Print Handout</button>
                    <button id="save-reading-btn"><i class="fas fa-save mr-1"></i>Save Fate</button>
                    <button id="load-saved-reading-btn"><i class="fas fa-folder-open mr-1"></i>Recall Prophecy</button>
                    <button id="clear-reading-btn"><i class="fas fa-trash-alt mr-1"></i>Clear</button>

                    <!-- Current Reading Display -->
                    <div id="current-reading-display">
                        <h4>Current Reading:</h4>
                        <ul id="current-reading-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- DM Card Info Box -->
            <div id="dm-card-info-box" class="faded-box">
                <h3 class="font-bold text-white mb-1">Card Insight:</h3>
                <p id="dm-card-info-text" class="text-gray-300 text-sm"></p>
            </div>
        </div>


        <!-- Card Spread Container -->
        <div id="card-spread-container" class="relative z-10">
            <!-- Card positions will be dynamically inserted here -->
            <div id="position-tome" class="card-position" data-position="tome"></div>
            <div id="position-holySymbol" class="card-position" data-position="holySymbol"></div>
            <div id="position-sunsword" class="card-position" data-position="sunsword"></div>
            <div id="position-ally" class="card-position" data-position="ally"></div>
            <div id="position-strahd" class="card-position" data-position="strahd"></div>
        </div>

        <!-- Fortune Display Area -->
        <div id="fortune-display" class="fortune-display">
            <!-- Fortunes will be dynamically inserted here -->
        </div>

        <!-- Prophecy Log Sidebar (always visible) -->
        <div id="prophecy-log">
            <h3>Prophecy Log</h3>
            <div id="log-entries">
                <!-- Log entries will be populated here -->
            </div>
        </div>

        <!-- Buttons outside DM interface, positioned near DM toggle -->
        <button id="cast-to-players-btn" class="faded-button dm-bottom-button">
            <i class="fas fa-tv mr-2"></i>Cast to Players
        </button>
        <button id="patreon-btn" class="faded-button dm-bottom-button" onclick="window.open('https://www.patreon.com/jimpeccable', '_blank');">
            <i class="fab fa-patreon mr-2"></i>Support Me on Patreon
        </button>

        <!-- DM Toggle Button (always visible) -->
        <button id="toggle-dm-btn">
            <i class="fas fa-hat-wizard mr-1"></i>DM Options
        </button>

        <!-- ESC Indicator for Cast Mode -->
        <div id="esc-indicator">ESC</div>

        <!-- Legal Mention -->
        <div id="legal-mention">
            <p>Card images &copy; Wizards of the Coast.</p>
            <p>Music by Samuel F. Johanns from Pixabay</p>
        </div>

        <!-- Volume Control Button and Slider -->
        <div id="volume-controls">
            <select id="music-selector" class="faded-button"></select> <!-- New music selector -->
            <button id="volume-btn">
                <i class="fas fa-volume-up"></i>
            </button>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.3">
        </div>
    </div>

    <!-- Background Music Audio Tag -->
    <audio id="background-music" src="/tarroka/IMG/music.mp3" loop preload="auto"></audio>
    <!-- Card Flip Sound Effect -->
    <audio id="flip-sound" src="/tarroka/IMG/cardflip.mp3" preload="auto"></audio>
    <!-- Shuffle Sound Effect -->
    <audio id="shuffle-sound" src="/tarroka/IMG/shuffle.mp3" preload="auto"></audio>

    <script>
        // --- IMPORTANT: CONFIGURE THIS BASE PATH FOR GITHUB PAGES ---
        // If your GitHub Pages URL is like https://yourusername.github.io/your-repo-name/
        // then set basePath = '/your-repo-name/IMG/';
        // If your GitHub Pages URL is like https://yourusername.github.io/ (user page)
        // and your IMG folder is at the root of that repo, then set basePath = '/IMG/';
        // If your IMG folder is in the same directory as this index.html, use '/tarroka/IMG/'
        const basePath = '/tarroka/IMG/'; // Default: assumes IMG is sibling to index.html

        // --- Tarokka Card Data ---
        // Full list of 54 Tarokka Cards with placeholder meanings.
        // Paths are updated to point to the IMG folder using basePath.
        // Fallback to placehold.co if local images are not found.
        const tarokkaCards = [
            // High Deck (Major Arcana - 14 cards)
            { id: 'artifact', name: 'The Artifact', suit: 'High', value: null, imageFront: basePath + 'The Artifact.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome is the key to knowledge and understanding. It reveals secrets long buried and paths yet unseen. Seek wisdom within its ancient pages.', holySymbol: 'The holy symbol radiates divine power, offering protection against the forces of darkness. It is a beacon of hope in despair.', sunsword: 'The sunsword is a weapon of light, capable of piercing the deepest shadows. It represents courage and the will to fight evil.', ally: 'Your fated ally is a steadfast companion, offering strength and guidance when you need it most. Trust in their loyalty.', strahd: 'Strahd\'s location is a place of ancient sorrow and forgotten power. It is here that his influence is strongest, and his secrets most guarded.' } },
            { id: 'beast', name: 'The Beast', suit: 'High', value: null, imageFront: basePath + 'The Beast.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome reveals the primal nature of the beast within. It speaks of uncontrolled urges and untamed power.', holySymbol: 'The holy symbol offers solace from the beast\'s hunger, a shield against its raw, destructive force.', sunsword: 'The sunsword is the only means to confront the beast, to tame its fury or to strike it down.', ally: 'Your ally is one who has faced the beast and survived, or perhaps one who struggles with their own inner monster.', strahd: 'Strahd\'s location is a lair, a place where primal instincts are unleashed and where he indulges his darkest desires.' } },
            { id: 'darklord', name: 'The Dark Master', suit: 'High', value: null, imageFront: basePath + 'The Dark Master.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of the Darklord\'s history, his rise to power, and the curse that binds him.', holySymbol: 'The holy symbol offers a glimmer of hope against the Darklord\'s tyranny, a resistance to his evil.', sunsword: 'The sunsword is the ultimate weapon against the Darklord, capable of breaking his hold and freeing the land.', ally: 'Your ally is one who stands directly against the Darklord, perhaps a former victim or a long-time foe.', strahd: 'Strahd\'s location is his throne, the seat of his power, where he holds court over his domain.' } },
            { id: 'ghost', name: 'The Spirit', suit: 'High', value: null, imageFront: basePath + 'The Spirit.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome reveals the tragic tale of a lost soul, a ghost bound to Barovia by unfinished business or lingering sorrow.', holySymbol: 'The holy symbol can offer peace to the restless spirit, or protection from its spectral touch.', sunsword: 'The sunsword can cut through the ethereal veil, allowing interaction with the spectral realm, or laying spirits to rest.', ally: 'Your ally is a spectral guide, a benevolent spirit, or someone haunted by a past trauma.', strahd: 'Strahd\'s location is a place of echoes and memories, where the past lingers like a cold mist.' } },
            { id: 'executioner', name: 'The Hangman', suit: 'High', value: null, imageFront: basePath + 'The Hangman.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome details the laws of judgment and the consequences of transgression. It speaks of justice, swift and unyielding.', holySymbol: 'The holy symbol offers mercy or a chance for redemption in the face of harsh judgment.', sunsword: 'The sunsword can be used to deliver a final blow, or to defend the innocent from unjust punishment.', ally: 'A figure of authority, a judge, or someone who enforces order, even if brutally so.', strahd: 'A place of punishment and suffering, where his enemies meet their grim end.' } },
            { id: 'horseman', name: 'The Horseman', suit: 'High', value: null, imageFront: basePath + 'The Horseman.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of journeys and distant lands, of the path ahead and the trials to come.', holySymbol: 'The holy symbol offers safe passage and protection on a perilous journey.', sunsword: 'The sunsword clears the way, cutting through obstacles and guiding the path forward.', ally: 'A traveler, a scout, or someone who knows the hidden roads and trails.', strahd: 'A place of transit, a crossroads, or a point from which he surveys his domain.' } },
            { id: 'innkeeper', name: 'The Innocent', suit: 'High', value: null, imageFront: basePath + 'The Innocent.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of hospitality and refuge, of secrets whispered in the common room and tales told by the fire.', holySymbol: 'The holy symbol offers sanctuary and comfort in a place of rest.', sunsword: 'The sunsword protects the innocent and ensures peace within the walls of a safe haven.', ally: 'A provider, a protector of travelers, or someone who offers a much-needed respite.', strahd: 'A place of false comfort, a trap disguised as refuge, or where he observes his unsuspecting victims.' } },
            { id: 'marionette', name: 'The Marionette', suit: 'High', value: null, imageFront: basePath + 'The Marionette.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome reveals the strings of fate, the hidden manipulations and the lack of free will. It speaks of being controlled.', holySymbol: 'The holy symbol can break the bonds of enchantment and manipulation, freeing the mind and spirit.', sunsword: 'The sunsword cuts the strings that bind, severing control and allowing true action.', ally: 'Someone who has broken free from control, or one who sees the hidden influences at play.', strahd: 'A place of control and subjugation, where he pulls the strings of his puppets.' } },
            { id: 'mists', name: 'The Mists', suit: 'High', value: null, imageFront: basePath + 'The Mists.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of the impenetrable fog that surrounds Barovia, and the secrets it holds within its swirling depths.', holySymbol: 'The holy symbol can part the mists, offering clarity and a glimpse of what lies beyond.', sunsword: 'The sunsword can cut a path through the mists, guiding the way through confusion and illusion.', ally: 'One who can navigate the mists, a guide through the unknown, or someone who understands its mysteries.', strahd: 'Strahd\'s location is hidden within the mists, a place obscured by illusion and difficult to reach.' } },
            { id: 'raven', name: 'The Raven', suit: 'High', value: null, imageFront: basePath + 'The Raven.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of ancient secrets and forgotten lore, often guarded by watchful eyes. It signifies a hidden truth.', holySymbol: 'The holy symbol offers insight and clarity, helping to discern truth from deception.', sunsword: 'The sunsword can reveal hidden paths or break through illusions, exposing what is concealed.', ally: 'A keeper of secrets, a wise elder, or one who has access to forbidden knowledge.', strahd: 'A place of concealed knowledge, where he hides his most guarded secrets.' } },
            { id: 'seer', name: 'The Hero', suit: 'High', value: null, imageFront: basePath + 'The Hero.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of prophecy and destiny, of visions of the future and the unfolding of fate.', holySymbol: 'The holy symbol enhances perception, allowing one to see beyond the ordinary veil.', sunsword: 'The sunsword can cut through illusions and reveal the true nature of things, even future events.', ally: 'A visionary, a prophet, or someone with keen insight into the unseen.', strahd: 'A place where he observes, where he can foresee events, or where he attempts to manipulate destiny.' } },
            { id: 'tempter', name: 'The Temptress', suit: 'High', value: null, imageFront: basePath + 'The Temptress.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of forbidden knowledge and dangerous allure, of choices that lead to ruin or power.', holySymbol: 'The holy symbol offers resistance to dark temptations and strengthens one\'s resolve.', sunsword: 'The sunsword can cut through deceptive appearances and expose the true nature of a tempting offer.', ally: 'One who has resisted temptation, or one who understands the nature of corruption.', strahd: 'A place of allure and deceit, where he offers dark bargains and preys on weaknesses.' } },
            { id: 'torturer', name: 'The Broken One', suit: 'High', value: null, imageFront: basePath + 'The Broken One.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of suffering and endurance, of the limits of pain and the breaking of spirit.', holySymbol: 'The holy symbol offers solace in suffering and strength to endure torment.', sunsword: 'The sunsword can end suffering, either by delivering justice or by providing a swift release.', ally: 'One who has endured great pain, or one who seeks to alleviate the suffering of others.', strahd: 'A dungeon, a torture chamber, or a place where he inflicts pain upon his victims.' } },
            { id: 'broken_one', name: 'The Broken One', suit: 'High', value: null, imageFront: basePath + 'The Broken One.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of shattered dreams and broken promises, of loss and the struggle for wholeness.', holySymbol: 'The holy symbol offers healing and restoration, mending what is broken.', sunsword: 'The sunsword can mend a fractured spirit or bring an end to a cycle of despair.', ally: 'One who is wounded but resilient, or one who helps others find healing.', strahd: 'A place of ruin and despair, reflecting his own shattered existence.' } },
            { id: 'donjon', name: 'The Prison', suit: 'High', value: null, imageFront: basePath + 'The Prison.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of confinement and isolation, of being trapped and the struggle for freedom.', holySymbol: 'The holy symbol offers a way out, a key to release, or a beacon of hope in captivity.', sunsword: 'The sunsword can cut through barriers and break chains, leading to liberation.', ally: 'A prisoner, an escapee, or one who knows the ways out of confinement.', strahd: 'A prison, a fortress, or a place from which there is no easy escape.' } },

            // Common Deck (4 suits, 10 cards each - numbered 1-9 + Master)
            // Swords (Scars) - 10 cards
            { id: 'swords-1', name: 'Ace of Swords', suit: 'Swords', value: 1, imageFront: basePath + 'Ace of Swords.png', imageBack: basePath + 'back.png', meanings: { tome: 'A sharp truth or a sudden insight.', holySymbol: 'Protection from verbal attacks or harmful ideas.', sunsword: 'A decisive action or a quick resolution to conflict.', ally: 'A quick-witted and sharp-tongued individual.', strahd: 'A place of conflict, sharp words, or intellectual challenge.' } },
            { id: 'swords-2', name: 'Two of Swords', suit: 'Swords', value: 2, imageFront: basePath + 'Two of Swords.png', imageBack: basePath + 'back.png', meanings: { tome: 'A dual nature or a difficult choice, often intellectual.', holySymbol: 'Balance and harmony in opposing forces.', sunsword: 'A duel or a challenge of two wills.', ally: 'Someone conflicted or with two sides to their nature.', strahd: 'A place of division or opposing forces, often a battleground.' } },
            { id: 'swords-3', name: 'Three of Swords', suit: 'Swords', value: 3, imageFront: basePath + 'Three of Swords.png', imageBack: basePath + 'back.png', meanings: { tome: 'A painful truth or a difficult revelation.', holySymbol: 'Spiritual resilience in the face of harsh realities.', sunsword: 'A necessary but painful cut, or a surgical strike.', ally: 'One who delivers hard truths, or has suffered greatly.', strahd: 'A place of sorrow, loss, or painful memories.' } },
            { id: 'swords-4', name: 'Four of Swords', suit: 'Swords', value: 4, imageFront: basePath + 'Four of Swords.png', imageBack: basePath + 'back.png', meanings: { tome: 'A period of truce, rest, or strategic pause.', holySymbol: 'Peace and calm amidst turmoil.', sunsword: 'A defensive stance or a fortified position.', ally: 'One who offers respite or a safe haven.', strahd: 'A place of temporary calm before a storm, or a strategic stronghold.' } },
            { id: 'swords-5', name: 'Five of Swords', suit: 'Swords', value: 5, imageFront: basePath + 'Five of Swords.png', imageBack: basePath + 'back.png', meanings: { tome: 'A hollow victory, defeat, or intellectual struggle.', holySymbol: 'Spiritual strength to overcome setbacks.', sunsword: 'A battle lost or a Pyrrhic victory.', ally: 'One who has faced defeat but learned from it.', strahd: 'A place of past defeats or where he has overcome rivals.' } },
            { id: 'swords-6', name: 'Six of Swords', suit: 'Swords', value: 6, imageFront: basePath + 'Six of Swords.png', imageBack: basePath + 'back.png', meanings: { tome: 'A journey away from conflict, or moving on from a difficult situation.', holySymbol: 'Guidance through troubled waters, or safe passage.', sunsword: 'A strategic retreat or a path to safety.', ally: 'One who helps others escape or find new beginnings.', strahd: 'A hidden escape route or a place of no return.' } },
            { id: 'swords-7', name: 'Seven of Swords', suit: 'Swords', value: 7, imageFront: basePath + 'Seven of Swords.png', imageBack: basePath + 'back.png', meanings: { tome: 'Deception, trickery, or hidden agendas.', holySymbol: 'Discernment to see through illusions.', sunsword: 'A weapon to expose lies or break enchantments.', ally: 'A cunning individual, or one who uncovers secrets.', strahd: 'A place of illusion, trickery, or hidden traps.' } },
            { id: 'swords-8', name: 'Eight of Swords', suit: 'Swords', value: 8, imageFront: basePath + 'Eight of Swords.png', imageBack: basePath + 'back.png', meanings: { tome: 'Feeling trapped or restricted by one\'s own thoughts or circumstances.', holySymbol: 'Spiritual liberation from self-imposed limitations.', sunsword: 'A tool to cut through mental or physical binds.', ally: 'One who helps others find freedom, or is themselves constrained.', strahd: 'A place of mental anguish or psychological torment.' } },
            { id: 'swords-9', name: 'Nine of Swords', suit: 'Swords', value: 9, imageFront: basePath + 'Nine of Swords.png', imageBack: basePath + 'back.png', meanings: { tome: 'Anxiety, despair, or profound mental anguish.', holySymbol: 'Comfort and solace in times of great distress.', sunsword: 'A desperate last stand, or the end of suffering.', ally: 'One who offers comfort or understands deep sorrow.', strahd: 'A place of nightmares and profound suffering.' } },
            { id: 'swords-master', name: 'Ten of Swords', suit: 'Swords', value: 10, imageFront: basePath + 'Ten of Swords.png', imageBack: basePath + 'back.png', meanings: { tome: 'Mastery over conflict, strategic insight, or intellectual prowess.', holySymbol: 'Ultimate spiritual fortitude and protection.', sunsword: 'Absolute victory, a final decisive strike, or military genius.', ally: 'A master of combat, strategy, or a skilled warrior.', strahd: 'Where his military might or strategic genius is most evident.' } },

            // Coins (Coins) - 10 cards
            { id: 'coins-1', name: 'Ace of Coins', suit: 'Coins', value: 1, imageFront: basePath + 'Ace of Coins.png', imageBack: basePath + 'back.png', meanings: { tome: 'A new opportunity, a fresh start in material wealth or resources.', holySymbol: 'Blessings for new ventures and prosperity.', sunsword: 'A tool to acquire new resources or defend existing wealth.', ally: 'A benefactor, a merchant, or someone who brings good fortune.', strahd: 'A place of hidden treasures or material gain.' } },
            { id: 'coins-2', name: 'Two of Coins', suit: 'Coins', value: 2, imageFront: basePath + 'Two of Coins.png', imageBack: basePath + 'back.png', meanings: { tome: 'Financial balance, partnership, or careful management of resources.', holySymbol: 'Harmony in material affairs.', sunsword: 'A fair exchange or a balanced transaction.', ally: 'A reliable partner in business or trade.', strahd: 'A place of negotiation or uneasy alliances concerning wealth.' } },
            { id: 'coins-3', name: 'Three of Coins', suit: 'Coins', value: 3, imageFront: basePath + 'Three of Coins.png', imageBack: basePath + 'back.png', meanings: { tome: 'Growth, collaboration, or building a foundation for future prosperity.', holySymbol: 'Divine blessing on creative endeavors.', sunsword: 'A tool for construction or or establishing a secure base.', ally: 'A skilled artisan, builder, or a supportive team member.', strahd: 'A place where his projects are underway, or where he consolidates power.' } },
            { id: 'coins-4', name: 'Four of Coins', suit: 'Coins', value: 4, imageFront: basePath + 'Four of Coins.png', imageBack: basePath + 'back.png', meanings: { tome: 'Stability, security, but also possessiveness or stagnation.', holySymbol: 'Spiritual grounding and protection of what is sacred.', sunsword: 'A defense of territory or possessions.', ally: 'A guardian, a collector, or someone resistant to change.', strahd: 'A heavily guarded vault or a place where he hoards his possessions.' } },
            { id: 'coins-5', name: 'Five of Coins', suit: 'Coins', value: 5, imageFront: basePath + 'Five of Coins.png', imageBack: basePath + 'back.png', meanings: { tome: 'Loss, poverty, or material hardship.', holySymbol: 'Charity and compassion, or finding spiritual wealth in adversity.', sunsword: 'A desperate struggle for survival or a last resort.', ally: 'One who is destitute, or one who offers aid to the needy.', strahd: 'A place of destitution, suffering, or where he takes from others.' } },
            { id: 'coins-6', name: 'Six of Coins', suit: 'Coins', value: 6, imageFront: basePath + 'Six of Coins.png', imageBack: basePath + 'back.png', meanings: { tome: 'Generosity, giving and receiving, or debt.', holySymbol: 'Divine grace and the flow of blessings.', sunsword: 'A fair distribution of resources or a just reward.', ally: 'A benefactor, a philanthropist, or someone who gives freely.', strahd: 'A place where he demands tribute or doles out favors.' } },
            { id: 'coins-7', name: 'Seven of Coins', suit: 'Coins', value: 7, imageFront: basePath + 'Seven of Coins.png', imageBack: basePath + 'back.png', meanings: { tome: 'Patience, investment, or waiting for results. Sometimes disappointment.', holySymbol: 'Trust in divine timing and spiritual growth.', sunsword: 'A long-term project or a patient siege.', ally: 'A diligent worker, a farmer, or one who waits for the right moment.', strahd: 'A place where he cultivates his plans, or where patience is required.' } },
            { id: 'coins-8', name: 'Eight of Coins', suit: 'Coins', value: 8, imageFront: basePath + 'Eight of Coins.png', imageBack: basePath + 'back.png', meanings: { tome: 'Skill, craftsmanship, or dedication to one\'s work.', holySymbol: 'Divine inspiration for creative endeavors.', sunsword: 'A finely crafted weapon or a tool of great precision.', ally: 'A master artisan, a dedicated student, or a skilled laborer.', strahd: 'A workshop, a laboratory, or where he perfects his dark arts.' } },
            { id: 'coins-9', name: 'Nine of Coins', suit: 'Coins', value: 9, imageFront: basePath + 'Nine of Coins.png', imageBack: basePath + 'back.png', meanings: { tome: 'Abundance, self-sufficiency, or material comfort.', holySymbol: 'Spiritual fulfillment and inner peace.', sunsword: 'A reward for hard work or a secure, prosperous position.', ally: 'A successful individual, or one who enjoys their independence.', strahd: 'A place of luxury and self-indulgence, or where he enjoys his conquests.' } },
            { id: 'coins-master', name: 'Ten of Coins', suit: 'Coins', value: 10, imageFront: basePath + 'Ten of Coins.png', imageBack: basePath + 'back.png', meanings: { tome: 'Ultimate financial security, profound understanding of resources, or shrewd business.', holySymbol: 'Abundant blessings and lasting prosperity.', sunsword: 'Securing vast wealth or protecting an empire of resources.', ally: 'A powerful patron, a master of commerce, or a wealthy individual.', strahd: 'His treasury, or where his vast wealth and influence are stored.' } },

            // Stars (Glyphs) - 10 cards
            { id: 'stars-1', name: 'Ace of Glyphs', suit: 'Stars', value: 1, imageFront: basePath + 'Ace of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'A guiding light, new hope, or inspiration in the darkness.', holySymbol: 'Illumination of the path and spiritual guidance.', sunsword: 'Shining brightly, revealing the way forward even in confusion.', ally: 'An inspiring figure, a beacon of hope, or a dream guide.', strahd: 'A place where hope is scarce, or where his dark influence eclipses all light.' } },
            { id: 'stars-2', name: 'Two of Glyphs', suit: 'Stars', value: 2, imageFront: basePath + 'Two of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'Intuition, mystery, or hidden knowledge. Often deception or illusion.', holySymbol: 'Enhanced perception, seeing beyond the ordinary veil.', sunsword: 'Cutting through illusions and revealing the true nature of things.', ally: 'One who is intuitive, secretive, or deals with the unseen.', strahd: 'A place of illusion, dreams, or where reality is distorted.' } },
            { id: 'stars-3', name: 'Three of Glyphs', suit: 'Stars', value: 3, imageFront: basePath + 'Three of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'Creative expression, intuition, or the unfolding of inner visions.', holySymbol: 'Divine inspiration for artistic or magical endeavors.', sunsword: 'Bringing ideas into reality, or manifesting desires.', ally: 'An artist, a visionary, or someone who inspires creativity.', strahd: 'A place where dark rituals are performed, or where he manifests his will.' } },
            { id: 'stars-4', name: 'Four of Glyphs', suit: 'Stars', value: 4, imageFront: basePath + 'Four of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'Stability in magic, or a structured approach to the unknown.', holySymbol: 'Spiritual discipline and control over mystical forces.', sunsword: 'A magical defense or a stable arcane foundation.', ally: 'A disciplined spellcaster or one who brings order to chaos.', strahd: 'A place of powerful magical wards or a controlled arcane environment.' } },
            { id: 'stars-5', name: 'Five of Glyphs', suit: 'Stars', value: 5, imageFront: basePath + 'Five of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'Spiritual crisis, loss of faith, or disillusionment.', holySymbol: 'Reclaiming faith and finding spiritual resilience.', sunsword: 'A challenge to one\'s beliefs or a test of magical prowess.', ally: 'One who has lost their way, or one who helps others find faith.', strahd: 'A place where faith is tested, or where he seeks to corrupt spirits.' } },
            { id: 'stars-6', name: 'Six of Glyphs', suit: 'Stars', value: 6, imageFront: basePath + 'Six of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'Moving towards enlightenment, or a journey of spiritual growth.', holySymbol: 'Divine guidance on a spiritual path.', sunsword: 'A path cleared by magic, or a journey through mystical realms.', ally: 'A spiritual guide, a mentor, or one who has walked a similar path.', strahd: 'A hidden magical path, or a journey into darkness.' } },
            { id: 'stars-7', name: 'Seven of Glyphs', suit: 'Stars', value: 7, imageFront: basePath + 'Seven of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'Hidden truths, illusions, or choices in the realm of magic.', holySymbol: 'Clarity amidst confusion, or discerning true magic from trickery.', sunsword: 'A weapon to dispel illusions or reveal hidden magical effects.', ally: 'A master illusionist, or one who sees beyond the veil.', strahd: 'A place of powerful illusions or hidden magical secrets.' } },
            { id: 'stars-8', name: 'Eight of Glyphs', suit: 'Stars', value: 8, imageFront: basePath + 'Eight of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'Magical apprenticeship, study, or developing arcane skills.', holySymbol: 'Divine knowledge and understanding of the mystical.', sunsword: 'A tool for magical practice or a focus for spells.', ally: 'A student of magic, a researcher, or a dedicated apprentice.', strahd: 'A library of forbidden lore, or where he studies dark magic.' } },
            { id: 'stars-9', name: 'Nine of Glyphs', suit: 'Glyphs', value: 9, imageFront: basePath + 'Nine of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'Spiritual fulfillment, inner wisdom, or dreams realized.', holySymbol: 'Divine connection and profound spiritual insight.', sunsword: 'A magical achievement or the culmination of arcane power.', ally: 'A wise hermit, a spiritual guru, or one who has found inner peace.', strahd: 'A place of dark contemplation or where he seeks ultimate power.' } },
            { id: 'stars-master', name: 'Ten of Glyphs', suit: 'Stars', value: 10, imageFront: basePath + 'Ten of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'Cosmic wisdom, understanding of destiny, or profound magical insight.', holySymbol: 'Divine insight and cosmic protection.', sunsword: 'Aligning with celestial power, granting immense magical ability.', ally: 'A powerful mage, a celestial being, or one with deep arcane knowledge.', strahd: 'A nexus of immense arcane power, or where he seeks to control the very stars.' } },

            // Glyphs (Scars) - 10 cards
            { id: 'glyphs-1', name: 'Ace of Scars', suit: 'Glyphs', value: 1, imageFront: basePath + 'Ace of Scars.png', imageBack: basePath + 'back.png', meanings: { tome: 'A new spiritual beginning, enlightenment, or divine inspiration.', holySymbol: 'A powerful blessing or a fresh surge of faith.', sunsword: 'A path illuminated by divine light, or a clear moral choice.', ally: 'A pure-hearted individual, or one who brings hope.', strahd: 'A place where light struggles against darkness, or where he seeks to corrupt innocence.' } },
            { id: 'glyphs-2', name: 'Two of Scars', suit: 'Glyphs', value: 2, imageFront: basePath + 'Two of Scars.png', imageBack: basePath + 'back.png', meanings: { tome: 'Spiritual partnership, shared beliefs, or a choice between two paths of faith.', holySymbol: 'Harmony in spiritual endeavors.', sunsword: 'A shared purpose or a unified front against evil.', ally: 'A devout companion, or one who shares your spiritual journey.', strahd: 'A place where spiritual beliefs clash, or where he seeks to divide faiths.' } },
            { id: 'glyphs-3', name: 'Three of Scars', suit: 'Glyphs', value: 3, imageFront: basePath + 'Three of Scars.png', imageBack: basePath + 'back.png', meanings: { tome: 'Celebration, community, or spiritual gathering.', holySymbol: 'Divine blessing on communal efforts.', sunsword: 'A joyous victory or a shared triumph over adversity.', ally: 'A leader of a community, or one who fosters unity.', strahd: 'A place of dark celebration or a gathering of his loyal servants.' } },
            { id: 'glyphs-4', name: 'Four of Scars', suit: 'Glyphs', value: 4, imageFront: basePath + 'Four of Scars.png', imageBack: basePath + 'back.png', meanings: { tome: 'Spiritual foundation, tradition, or conservative beliefs.', holySymbol: 'Unwavering faith and divine protection of sacred traditions.', sunsword: 'A strong defense of principles or a fortified spiritual position.', ally: 'A traditionalist, an elder, or one who upholds ancient customs.', strahd: 'A place of ancient traditions he seeks to corrupt, or a stronghold of his dark faith.' } },
            { id: 'glyphs-5', name: 'Five of Scars', suit: 'Glyphs', value: 5, imageFront: basePath + 'Five of Scars.png', imageBack: basePath + 'back.png', meanings: { tome: 'Spiritual conflict, loss of faith, or moral crisis.', holySymbol: 'Guidance through spiritual trials and renewed faith.', sunsword: 'A test of conviction or a challenge to one\'s beliefs.', ally: 'One who has faced and overcome a spiritual crisis.', strahd: 'A place of spiritual despair or where faith is shattered.' } },
            { id: 'glyphs-6', name: 'Six of Scars', suit: 'Glyphs', value: 6, imageFront: basePath + 'Six of Scars.png', imageBack: basePath + 'back.png', meanings: { tome: 'Nostalgia, healing from the past, or returning to spiritual roots.', holySymbol: 'Divine comfort and reconciliation.', sunsword: 'A journey of healing or a return to a place of spiritual significance.', ally: 'One who brings comfort, or helps reconcile past grievances.', strahd: 'A place of lingering regret or where he seeks to twist past memories.' } },
            { id: 'glyphs-7', name: 'Seven of Scars', suit: 'Glyphs', value: 7, imageFront: basePath + 'Seven of Scars.png', imageBack: basePath + 'back.png', meanings: { tome: 'Spiritual temptation, hidden motives, or choices of faith.', holySymbol: 'Discernment to see through spiritual deceit.', sunsword: 'A weapon to expose hypocrisy or false prophets.', ally: 'One who tests faith, or reveals hidden truths.', strahd: 'A place of false worship or where he preys on spiritual weakness.' } },
            { id: 'glyphs-8', name: 'Eight of Scars', suit: 'Glyphs', value: 8, imageFront: basePath + 'Eight of Scars.png', imageBack: basePath + 'back.png', meanings: { tome: 'Spiritual discipline, introspection, or seeking deeper meaning.', holySymbol: 'Divine wisdom and profound spiritual understanding.', sunsword: 'A tool for self-mastery or a focused spiritual quest.', ally: 'A hermit, a monk, or one who seeks solitude for spiritual growth.', strahd: 'A place of dark contemplation or where he seeks forbidden knowledge.' } },
            { id: 'glyphs-9', name: 'Nine of Glyphs', suit: 'Glyphs', value: 9, imageFront: basePath + 'Nine of Glyphs.png', imageBack: basePath + 'back.png', meanings: { tome: 'Spiritual enlightenment, fulfillment, or divine blessing.', holySymbol: 'Profound spiritual connection and inner radiance.', sunsword: 'A beacon of hope and light, or a divine intervention.', ally: 'A saintly figure, a healer, or one who radiates positive energy.', strahd: 'A place where he attempts to extinguish all hope and light.' } },
            { id: 'glyphs-master', name: 'Ten of Scars', suit: 'Glyphs', value: 10, imageFront: basePath + 'Ten of Scars.png', imageBack: basePath + 'back.png', meanings: { tome: 'Profound spiritual knowledge, divine guidance, or ultimate faith.', holySymbol: 'Absolute divine protection and spiritual power.', sunsword: 'A weapon of holy vengeance or ultimate spiritual authority.', ally: 'A powerful cleric, a spiritual leader, or a divine agent.', strahd: 'A nexus of dark magic, where his most potent spells are woven.' } },

            // Face Cards (4 suits, 3 cards each - 12 cards total)
            // Assign these to specific suits
            { id: 'warrior', name: 'Warrior', suit: 'Swords', value: null, imageFront: basePath + 'Warrior.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of courage and martial prowess.', holySymbol: 'The holy symbol offers divine protection in battle.', sunsword: 'The sunsword is wielded by a true warrior.', ally: 'Your ally is a skilled combatant.', strahd: 'Strahd\'s location is a place of battle or military might.' } },
            { id: 'rogue', name: 'Rogue', suit: 'Coins', value: null, imageFront: basePath + 'Rogue.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome reveals hidden paths and cunning strategies.', holySymbol: 'The holy symbol offers stealth and protection from detection.', sunsword: 'The sunsword can bypass defenses or strike from the shadows.', ally: 'Your ally is cunning and agile, a master of shadows.', strahd: 'Strahd\'s location is a place of intrigue, hidden passages, or traps.' } },
            { id: 'mage', name: 'Mage', suit: 'Stars', value: null, imageFront: basePath + 'Mage.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of arcane secrets and powerful spells.', holySymbol: 'The holy symbol offers protection against dark magic.', sunsword: 'The sunsword channels raw magical energy.', ally: 'Your ally is a powerful spellcaster.', strahd: 'Strahd\'s location is a place of immense magical power.' } },
            { id: 'priest', name: 'Priest', suit: 'Glyphs', value: null, imageFront: basePath + 'Priest.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome reveals divine knowledge and sacred rituals.', holySymbol: 'The holy symbol offers profound spiritual healing and protection.', sunsword: 'The sunsword is blessed with divine power.', ally: 'Your ally is a devout and wise spiritual leader.', strahd: 'Strahd\'s location is a place of corrupted faith or unholy rituals.' } },

            { id: 'knight', name: 'Knight', suit: 'Swords', value: null, imageFront: basePath + 'Knight.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of chivalry and duty.', holySymbol: 'The holy symbol offers righteous protection.', sunsword: 'The sunsword offers righteous protection.', ally: 'Your ally is a brave and honorable knight.', strahd: 'Strahd\'s location is a place of fallen heroes or broken oaths.' } },
            { id: 'thief', name: 'Thief', suit: 'Coins', value: null, imageFront: basePath + 'Thief.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome reveals hidden stashes and illicit dealings.', holySymbol: 'The holy symbol offers a way to reclaim stolen goods.', sunsword: 'The sunsword can cut through locks or sever connections to ill-gotten gains.', ally: 'Your ally is resourceful and skilled in acquiring what is needed.', strahd: 'Strahd\'s location is a place of ill-gotten wealth or stolen artifacts.' } },
            { id: 'wizard', name: 'Wizard', suit: 'Stars', value: null, imageFront: basePath + 'Wizard.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of ancient spells and forgotten lore.', holySymbol: 'The holy symbol offers protection against dark enchantments.', sunsword: 'The sunsword can channel immense magical power.', ally: 'Your ally is a wise and powerful wizard.', strahd: 'Strahd\'s location is a library of forbidden magic or a wizard\'s tower.' } },
            { id: 'cleric', name: 'Cleric', suit: 'Glyphs', value: null, imageFront: basePath + 'Cleric.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome reveals divine revelations and sacred texts.', holySymbol: 'The holy symbol offers profound healing and spiritual guidance.', sunsword: 'The sunsword is imbued with holy power.', ally: 'Your ally is a devoted and compassionate cleric.', strahd: 'Strahd\'s location is a desecrated shrine or a place of twisted faith.' } },

            { id: 'paladin', name: 'Paladin', suit: 'Swords', value: null, imageFront: basePath + 'Paladin.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of righteous crusades and sacred oaths.', holySymbol: 'The holy symbol offers unwavering divine protection and justice.', sunsword: 'The sunsword is a weapon of pure divine light against evil.', ally: 'Your ally is a zealous and unyielding paladin.', strahd: 'Strahd\'s location is a place where good has been corrupted or a holy site defiled.' } },
            { id: 'bard', name: 'Bard', suit: 'Coins', value: null, imageFront: basePath + 'Bard.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of inspiring tales and forgotten songs.', holySymbol: 'The holy symbol offers solace through art and performance.', sunsword: 'The sunsword can inspire allies or dishearten foes with its presence.', ally: 'Your ally is a charismatic storyteller or a master of song.', strahd: 'Strahd\'s location is a place of twisted entertainment or forced revelry.' } },
            { id: 'sorcerer', name: 'Sorcerer', suit: 'Stars', value: null, imageFront: basePath + 'Sorcerer.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of innate magical talent and raw power.', holySymbol: 'The holy symbol offers control over wild magic.', sunsword: 'The sunsword can channel untamed arcane energy.', ally: 'Your ally possesses powerful innate magical abilities.', strahd: 'Strahd\'s location is a place where raw magic runs wild or is dangerously contained.' } },
            { id: 'druid', name: 'Druid', suit: 'Glyphs', value: null, imageFront: basePath + 'Druid.png', imageBack: basePath + 'back.png', meanings: { tome: 'The tome speaks of natural cycles and ancient wilderness lore.', holySymbol: 'The holy symbol offers connection to nature and its healing powers.', sunsword: 'The sunsword can restore natural balance or cut through unnatural growth.', ally: 'Your ally is a protector of nature or a shapeshifter.', strahd: 'Strahd\'s location is a corrupted natural site or a twisted grove.' } },
        ];

        // Ensure there are exactly 54 cards for a full deck simulation
        // This loop will fill any missing cards with duplicates if the array is manually shortened,
        // or trim it if it's accidentally lengthened.
        while (tarokkaCards.length < 54) {
            tarokkaCards.push(tarokkaCards[Math.floor(Math.random() * tarokkaCards.length)]);
        }
        if (tarokkaCards.length > 54) {
            tarokkaCards.splice(54);
        }

        // Music track data - predefined list
        const musicTracks = [
            { id: 'music_default', name: 'Music 1 (Default)', src: basePath + 'music.mp3' },
            { id: 'music_2', name: 'Music 2', src: basePath + 'music2.mp3' },
            { id: 'music_3', name: 'Music 3', src: basePath + 'music3.mp3' },
            { id: 'music_4', name: 'Music 4', src: basePath + 'music4.mp3' },
            { id: 'music_5', name: 'Music 5', src: basePath + 'music5.mp3' }
        ];


        // --- Global Variables ---
        let currentDeck = [...tarokkaCards]; // Working copy of the deck
        let dealtCards = {
            tome: null,
            holySymbol: null,
            sunsword: null,
            ally: null,
            strahd: null
        };
        const fortunePositions = ['tome', 'holySymbol', 'sunsword', 'ally', 'strahd'];
        let isDmPanelVisible = false; // State for DM panel visibility
        let isCastModeActive = false; // State for Cast mode

        // --- DOM Elements ---
        const preloader = document.getElementById('preloader');
        const backgroundTable = document.getElementById('background-table');
        const mainGameView = document.getElementById('main-game-view');

        // Main Game View elements
        const cardSpreadContainer = document.getElementById('card-spread-container');
        const fortuneDisplay = document.getElementById('fortune-display');
        const prophecyLog = document.getElementById('prophecy-log');
        const logEntriesContainer = document.getElementById('log-entries');
        const candleLightSource = document.getElementById('candle-light-source');

        // DM Interface Container elements
        const dmInterfaceContainer = document.getElementById('dm-interface-container');
        const dmControlPanel = document.getElementById('dm-control-panel');
        const currentReadingList = document.getElementById('current-reading-list');
        // castToPlayersBtn and patreonBtn are now global, not inside dmInterfaceContainer
        const castToPlayersBtn = document.getElementById('cast-to-players-btn');
        const patreonBtn = document.getElementById('patreon-btn');
        const dmCardInfoBox = document.getElementById('dm-card-info-box'); // New DM info box
        const dmCardInfoText = document.getElementById('dm-card-info-text'); // Text inside DM info box


        // Buttons
        const toggleDmBtn = document.getElementById('toggle-dm-btn');
        const randomizeAllBtn = document.getElementById('randomize-all-btn');
        const shuffleDealBtn = document.getElementById('shuffle-deal-btn');
        const revealAllBtn = document.getElementById('reveal-all-btn');
        const hideAllBtn = document.getElementById('hide-all-btn');
        const printHandoutBtn = document.getElementById('print-handout-btn');
        const saveReadingBtn = document.getElementById('save-reading-btn');
        const volumeBtn = document.getElementById('volume-btn'); // Volume button
        const volumeSlider = document.getElementById('volume-slider'); // Volume slider
        const backgroundMusic = document.getElementById('background-music'); // Audio element
        const flipSound = document.getElementById('flip-sound'); // Audio element for flip sound
        const shuffleSound = document.getElementById('shuffle-sound'); // Audio element for shuffle sound
        const musicSelector = document.getElementById('music-selector'); // New music selector


        // ESC Indicator
        const escIndicator = document.getElementById('esc-indicator');


        // --- Utility Functions ---

        /**
         * Fisher-Yates (Knuth) Shuffle algorithm.
         * @param {Array} array - The array to shuffle.
         * @returns {Array} - The shuffled array.
         */
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        /**
         * Creates and appends a dust mote to the specified container.
         */
        function createDustMote() {
            const dustMotesContainer = document.querySelector('.dust-motes');
            const mote = document.createElement('div');
            mote.classList.add('dust-mote');
            const size = Math.random() * 3 + 1; // 1 to 4px
            mote.style.width = `${size}px`;
            mote.style.height = `${size}px`;
            mote.style.left = `${Math.random() * 100}%`;
            mote.style.top = `${Math.random() * 100}%`;
            mote.style.animationDelay = `-${Math.random() * 10}s`; // Stagger animation start
            dustMotesContainer.appendChild(mote);
        }

        /**
         * Initializes dust motes.
         */
        function initDustMotes(count = 50) {
            for (let i = 0; i < count; i++) {
                createDustMote();
            }
        }

        /**
         * Creates a visual representation of a card.
         * Returns a Promise that resolves with the card element once both front and back images are loaded.
         * @param {Object} cardData - The card object from tarokkaCards.
         * @param {boolean} isFlipped - Whether the card should be shown face up.
         * @returns {Promise<HTMLElement>} - A promise resolving to the card DOM element.
         */
        function createCardElement(cardData, isFlipped = false) {
            return new Promise(resolve => {
                console.log(`createCardElement: Creating card for ${cardData.name}, front: ${cardData.imageFront}, back: ${cardData.imageBack}`);
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.cardId = cardData.id;
                card.dataset.position = '';

                const cardFront = document.createElement('div');
                cardFront.classList.add('card-face', 'card-front');
                const frontImage = new Image();
                let frontLoaded = false;
                frontImage.onload = () => {
                    cardFront.style.backgroundImage = `url('${cardData.imageFront}')`;
                    console.log(`createCardElement: Front image loaded for ${cardData.name}`);
                    frontLoaded = true;
                    if (backLoaded) resolve(card); // Resolve when both are loaded
                };
                frontImage.onerror = () => {
                    console.error(`createCardElement: Failed to load front image for ${cardData.name} from ${cardData.imageFront}. Using placeholder.`);
                    cardFront.style.backgroundImage = `url('https://placehold.co/110x190/333333/FFFFFF?text=${cardData.name.replace(/ /g, '+')}')`;
                    frontLoaded = true;
                    if (backLoaded) resolve(card);
                };
                frontImage.src = cardData.imageFront;


                const cardBack = document.createElement('div');
                cardBack.classList.add('card-face', 'card-back');
                const backImage = new Image();
                let backLoaded = false;
                backImage.onload = () => {
                    cardBack.style.backgroundImage = `url('${cardData.imageBack}')`;
                    console.log(`createCardElement: Back image loaded for ${cardData.name}`);
                    backLoaded = true;
                    if (frontLoaded) resolve(card); // Resolve when both are loaded
                };
                backImage.onerror = () => {
                    console.error(`createCardElement: Failed to load back image for ${cardData.name} from ${cardData.imageBack}. Using placeholder.`);
                    cardBack.style.backgroundImage = `url('https://placehold.co/110x190/3A1F1F/B8860B?text=Tarokka+Back+Ornate')`;
                    backLoaded = true;
                    if (frontLoaded) resolve(card);
                };
                backImage.src = cardData.imageBack;

                card.appendChild(cardFront);
                card.appendChild(cardBack);

                if (isFlipped) {
                    card.classList.add('flipped');
                    console.log(`createCardElement: Card ${cardData.name} initialized as flipped.`);
                }

                // Add hover effects directly to the card element
                card.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('flipped')) {
                        this.style.transform = `translateY(-10px) scale(1.05) translate(${cardMoveX}px, ${cardMoveY}px)`; // Apply parallax on hover
                    }
                });

                card.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('flipped')) {
                        this.style.transform = `translateY(0) scale(1) translate(${cardMoveX}px, ${cardMoveY}px)`; // Reset parallax on leave
                    }
                });

                // If images are already cached/loaded, they might fire onload immediately.
                // Handle case where both are already loaded before event listeners are fully set up.
                if (frontImage.complete && backImage.complete) {
                    frontLoaded = true;
                    backLoaded = true;
                    console.log(`createCardElement: Both images already complete for ${cardData.name}. Resolving immediately.`);
                    resolve(card);
                }
            });
        }

        /**
         * Renders the initial empty card positions.
         */
        function renderEmptyCardPositions() {
            console.log('renderEmptyCardPositions: Clearing all card positions.');
            fortunePositions.forEach(pos => {
                const positionDiv = document.getElementById(`position-${pos}`);
                if (positionDiv) {
                    positionDiv.innerHTML = ''; // Clear previous content
                    positionDiv.classList.remove('has-card'); // Ensure no card class
                }
            });
        }

        /**
         * Deals cards to the specified positions.
         * @param {Object} cardsToDeal - An object mapping position names to card objects.
         * @param {boolean} animate - Whether to show a dealing animation.
         */
        async function dealCards(cardsToDeal, animate = true) {
            console.log('dealCards: Starting to deal cards.');
            // Clear existing cards
            renderEmptyCardPositions();
            hideAllFortunes(); // Hide fortune display
            clearProphecyLog(); // Clear prophecy log on new deal
            hideDmCardInfo(); // Hide DM info box on new deal

            const cardCreationPromises = [];

            for (const pos of fortunePositions) {
                const cardData = cardsToDeal[pos];
                if (cardData) {
                    const positionDiv = document.getElementById(`position-${pos}`);
                    positionDiv.classList.add('has-card');

                    // Create card element and wait for its images to load
                    const cardPromise = createCardElement(cardData, false);
                    cardCreationPromises.push(cardPromise);

                    cardPromise.then(cardElement => {
                        cardElement.dataset.position = pos;
                        cardElement.addEventListener('click', () => {
                            console.log(`Card clicked: ${cardData.name} at ${pos}`);
                            if (!cardElement.classList.contains('flipped')) {
                                flipCard(cardElement, cardData, pos);
                            }
                        });
                        positionDiv.appendChild(cardElement);

                        if (animate) {
                            cardElement.style.transition = 'none';
                            cardElement.style.opacity = '0';
                            cardElement.style.transform = 'translateY(-20px)';
                            setTimeout(() => { // Use setTimeout for animation start
                                cardElement.style.opacity = '1';
                                cardElement.style.transform = 'translateY(0)';
                                cardElement.style.transition = ''; // Reset to CSS defined transition
                            }, 100 * fortunePositions.indexOf(pos)); // Stagger deal
                        }
                    });
                }
            }
            await Promise.all(cardCreationPromises); // Wait for all cards to be created and images loaded
            console.log('dealCards: All card elements created and images loaded.');

            dealtCards = cardsToDeal; // Update global state
            updateCurrentReadingDisplay(); // Update DM panel display
        }

        /**
         * Flips a card and displays its meaning.
         * @param {HTMLElement} cardElement - The card DOM element.
         * @param {Object} cardData - The card object.
         * @param {string} positionName - The name of the fortune position (e.g., 'tome').
         */
        function flipCard(cardElement, cardData, positionName) {
            console.log(`flipCard: Attempting to flip card ${cardData.name} at ${positionName}`);
            if (cardElement.classList.contains('flipped')) {
                console.log(`flipCard: Card ${cardData.name} already flipped.`);
                return; // Already flipped
            }
            
            // Play flip sound effect if available
            playFlipSound();

            // Add the flipped class for CSS animation
            cardElement.classList.add('flipped');
            console.log(`flipCard: 'flipped' class added to ${cardData.name}.`);
            
            // Update the card front with the revealed card image
            const cardFront = cardElement.querySelector('.card-front');
            if (cardFront && cardData.imageFront) {
                // Ensure the image is loaded before setting it as background
                const img = new Image();
                img.onload = () => {
                    cardFront.style.backgroundImage = `url(${cardData.imageFront})`;
                    cardFront.style.backgroundSize = 'cover';
                    cardFront.style.backgroundPosition = 'center';
                };
                img.onerror = () => {
                    console.error(`flipCard: Failed to load front image for ${cardData.name} from ${cardData.imageFront}. Using placeholder.`);
                    cardFront.style.backgroundImage = `url('https://placehold.co/110x190/333333/FFFFFF?text=${cardData.name.replace(/ /g, '+')}')`;
                };
                img.src = cardData.imageFront;
            }
            
            // Add a small delay before showing fortune to allow flip animation
            setTimeout(() => {
                displayFortune(cardData, positionName);
                addEntryToProphecyLog(cardData, positionName);
                // Only display DM info box if DM panel is visible AND cast mode is NOT active
                if (isDmPanelVisible && !isCastModeActive) {
                    displayDmCardInfo(cardData, positionName);
                }
            }, 1200); // Match your CSS transition duration
        }

        /**
         * Displays the fortune text for a revealed card.
         * @param {Object} cardData - The card object.
         * @param {string} positionName - The name of the fortune position.
         */
        function displayFortune(cardData, positionName) {
            console.log(`displayFortune: Displaying fortune for ${cardData.name} at ${positionName}.`);
            const fortuneText = cardData.meanings[positionName] || 'No specific fortune for this position.';
            const positionTitle = positionName.charAt(0).toUpperCase() + positionName.slice(1); // Capitalize
            
            // Get or create the fortune display container
            const fortuneDisplay = document.getElementById('fortune-display') || 
                                 document.querySelector('.fortune-display');
            
            if (!fortuneDisplay) {
                console.error('Fortune display container not found');
                return;
            }
            
            let fortuneEntry = document.getElementById(`fortune-entry-${positionName}`);
            
            if (!fortuneEntry) {
                fortuneEntry = document.createElement('div');
                fortuneEntry.id = `fortune-entry-${positionName}`;
                fortuneEntry.classList.add('fortune-entry', 'opacity-0'); // Start hidden for fade-in
                fortuneDisplay.appendChild(fortuneEntry);
            }
            
            fortuneEntry.innerHTML = `
                <h3 class="text-xl font-bold">${positionTitle}: ${cardData.name}</h3>
                <p class="mt-2">${fortuneText}</p>
            `;
            
            // Apply fade-in animation
            fortuneEntry.style.transition = 'opacity 0.5s ease-in-out';
            setTimeout(() => {
                fortuneEntry.classList.remove('opacity-0');
                fortuneEntry.classList.add('opacity-100');
            }, 50);
            
            fortuneDisplay.classList.add('active');
        }

        /**
         * Hides all fortune text.
         */
        function hideAllFortunes() {
            console.log('hideAllFortunes: Hiding all fortune displays.');
            if (fortuneDisplay) {
                fortuneDisplay.classList.remove('active');
                setTimeout(() => {
                    fortuneDisplay.innerHTML = '';
                    Array.from(fortuneDisplay.children).forEach(child => child.classList.add('opacity-0'));
                }, 500);
            }
        }

        /**
         * Displays the rephrased card meaning in the DM info box.
         * @param {Object} cardData - The card object.
         * @param {string} positionName - The name of the fortune position.
         */
        function displayDmCardInfo(cardData, positionName) {
            if (!dmCardInfoBox || !dmCardInfoText) {
                console.error('DM card info box elements not found.');
                return;
            }

            const positionTitle = positionName.charAt(0).toUpperCase() + positionName.slice(1);
            const originalMeaning = cardData.meanings[positionName] || 'No specific meaning found.';

            let rephrasedMeaning = '';
            switch (positionName) {
                case 'tome':
                    rephrasedMeaning = `The Tome whispers of **${cardData.name}**: "${originalMeaning}"`;
                    break;
                case 'holySymbol':
                    rephrasedMeaning = `The Holy Symbol shines upon **${cardData.name}**: "${originalMeaning}"`;
                    break;
                case 'sunsword':
                    rephrasedMeaning = `The Sunsword points to **${cardData.name}**: "${originalMeaning}"`;
                    break;
                case 'ally':
                    rephrasedMeaning = `Your Fated Ally is revealed as **${cardData.name}**: "${originalMeaning}"`;
                    break;
                case 'strahd':
                    rephrasedMeaning = `Strahd's presence is tied to **${cardData.name}**: "${originalMeaning}"`;
                    break;
                default:
                    rephrasedMeaning = `A card, **${cardData.name}**, appears at the ${positionTitle} position: "${originalMeaning}"`;
            }
            
            dmCardInfoText.innerHTML = rephrasedMeaning;
            dmCardInfoBox.classList.add('active');
            console.log(`displayDmCardInfo: Displayed info for ${cardData.name}.`);
        }

        /**
         * Hides the DM card info box.
         */
        function hideDmCardInfo() {
            if (dmCardInfoBox) {
                dmCardInfoBox.classList.remove('active');
                dmCardInfoText.innerHTML = ''; // Clear content
                console.log('hideDmCardInfo: DM info box hidden.');
            }
        }

        /**
         * Populates the DM rigging dropdowns with all card options.
         */
        function populateRiggingDropdowns() {
            console.log('populateRiggingDropdowns: Populating rigging dropdowns.');
            fortunePositions.forEach(pos => {
                const selectElement = document.getElementById(`rig-${pos}`);
                if (selectElement) {
                    selectElement.innerHTML = '<option value="">-- Random --</option>'; // Default option
                    tarokkaCards.forEach(card => {
                        const option = document.createElement('option');
                        option.value = card.id;
                        option.textContent = `${card.name} (${card.suit})`;
                        selectElement.appendChild(option);
                    });

                    // Add event listener for rigging
                    selectElement.addEventListener('change', (event) => {
                        const selectedCardId = event.target.value;
                        const position = event.target.dataset.position;
                        const cardData = tarokkaCards.find(c => c.id === selectedCardId);
                        dealtCards[position] = cardData || null; // Update dealtCards directly
                        updateCurrentReadingDisplay(); // Update DM panel display immediately
                        console.log(`Rigged ${cardData ? cardData.name : 'random'} for ${position}.`);
                    });
                }
            });
        }

        /**
         * Updates the "Current Reading" display in the DM panel.
         */
        function updateCurrentReadingDisplay() {
            if (currentReadingList) {
                currentReadingList.innerHTML = '';
                fortunePositions.forEach(pos => {
                    const card = dealtCards[pos];
                    const listItem = document.createElement('li');
                    if (card) {
                        listItem.innerHTML = `<strong>${pos.charAt(0).toUpperCase() + pos.slice(1)}:</strong> <span>${card.name}</span>`;
                    } else {
                        listItem.innerHTML = `<strong>${pos.charAt(0).toUpperCase() + pos.slice(1)}:</strong> <span>(Not set)</span>`;
                    }
                    currentReadingList.appendChild(listItem);
                });
                console.log('updateCurrentReadingDisplay: Current reading display updated.');
            }
        }

        /**
         * Adds an entry to the Prophecy Log sidebar.
         * @param {Object} cardData - The card object.
         * @param {string} positionName - The name of the fortune position.
         */
        function addEntryToProphecyLog(cardData, positionName) {
            if (logEntriesContainer) {
                const logEntry = document.createElement('div');
                logEntry.classList.add('log-entry', 'opacity-0');

                const cardThumbnail = document.createElement('div');
                cardThumbnail.classList.add('card-thumbnail');
                const thumbImage = new Image();
                thumbImage.onload = () => { cardThumbnail.style.backgroundImage = `url('${cardData.imageFront}')`; };
                thumbImage.onerror = () => { cardThumbnail.style.backgroundImage = `url('https://placehold.co/110x190/333333/FFFFFF?text=Thumb')`; };
                thumbImage.src = cardData.imageFront;

                const logText = document.createElement('div');
                logText.classList.add('log-text');
                logText.innerHTML = `
                    <strong>${positionName.charAt(0).toUpperCase() + positionName.slice(1)}:</strong>
                    <span>${cardData.name}</span>
                `;

                logEntry.appendChild(cardThumbnail);
                logEntry.appendChild(logText);
                logEntriesContainer.appendChild(logEntry);
                logEntriesContainer.scrollTop = logEntriesContainer.scrollHeight;
                setTimeout(() => logEntry.classList.remove('opacity-0'), 50);
                console.log(`addEntryToProphecyLog: Added ${cardData.name} to log.`);
            }
        }

        /**
         * Clears all entries from the Prophecy Log sidebar.
         */
        function clearProphecyLog() {
            if (logEntriesContainer) {
                logEntriesContainer.innerHTML = '';
                console.log('clearProphecyLog: Prophecy log cleared.');
            }
        }

        /**
         * Handles the "Shuffle & Deal" action.
         */
        async function handleShuffleAndDeal() {
            console.log('handleShuffleAndDeal: Shuffling and dealing cards.');
            playShuffleSound(); // Play shuffle sound
            currentDeck = shuffleArray([...tarokkaCards]); // Reshuffle the full deck

            const newDealtCards = {};
            const availableCards = [...currentDeck]; // Use a copy of the shuffled deck

            // Get rigged cards directly from the dropdowns
            const riggedSelections = {};
            fortunePositions.forEach(pos => {
                const selectElement = document.getElementById(`rig-${pos}`);
                if (selectElement && selectElement.value) {
                    riggedSelections[pos] = selectElement.value;
                }
            });

            for (const pos of fortunePositions) {
                const riggedCardId = riggedSelections[pos];
                if (riggedCardId) {
                    const riggedCardIndex = availableCards.findIndex(card => card.id === riggedCardId);
                    if (riggedCardIndex !== -1) {
                        newDealtCards[pos] = availableCards.splice(riggedCardIndex, 1)[0];
                    } else {
                        // If rigged card is not found (e.g., already used or invalid), pick random
                        newDealtCards[pos] = availableCards.pop();
                        console.warn(`Rigged card ${riggedCardId} for ${pos} not found or already used. Assigning random card.`);
                    }
                } else {
                    newDealtCards[pos] = availableCards.pop();
                }
            }

            await dealCards(newDealtCards, true); // Deal with animation
            hideAllFortunes(); // Ensure fortunes are hidden initially
            hideDmCardInfo(); // Ensure DM info box is hidden initially
            console.log('handleShuffleAndDeal: Cards shuffled and dealt.');
        }

        /**
         * Handles "Randomize All" button.
         */
        function handleRandomizeAll() {
            console.log('handleRandomizeAll: Randomizing all rigging dropdowns.');
            fortunePositions.forEach(pos => {
                const selectElement = document.getElementById(`rig-${pos}`);
                if (selectElement) {
                    selectElement.value = ''; // Reset dropdowns
                }
            });
            updateCurrentReadingDisplay(); // Update DM panel display immediately
        }

        /**
         * Handles "Reveal All" button.
         */
        function handleRevealAll() {
            console.log('handleRevealAll: Revealing all cards.');
            hideAllFortunes(); // Clear previous fortunes
            hideDmCardInfo(); // Clear DM info box

            fortunePositions.forEach(pos => {
                const cardElement = document.querySelector(`#position-${pos} .card`);
                const cardData = dealtCards[pos];
                if (cardElement && cardData) {
                    flipCard(cardElement, cardData, pos);
                }
            });
        }

        /**
         * Handles "Hide All" button.
         */
        function handleHideAll() {
            console.log('handleHideAll: Hiding all cards.');
            fortunePositions.forEach(pos => {
                const cardElement = document.querySelector(`#position-${pos} .card`);
                if (cardElement) {
                    cardElement.classList.remove('flipped');
                }
            });
            hideAllFortunes();
            clearProphecyLog(); // Clear log when hiding cards
            hideDmCardInfo(); // Hide DM info box
        }

        /**
         * Handles printing the player handout.
         */
        function printPlayerHandout() {
            console.log('printPlayerHandout: Generating handout.');
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Tarokka Reading Handout</title>');
            printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: 'Merriweather', serif; margin: 20px; color: #333; }
                h1 { text-align: center; color: #5C001F; margin-bottom: 30px; }
                .fortune-section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
                .fortune-section h2 { color: #B8860B; margin-bottom: 10px; }
                .card-image { max-width: 110px; height: auto; float: right; margin-left: 15px; border: 1px solid #eee; border-radius: 5px; }
                @media print {
                    body { font-size: 12pt; }
                    .fortune-section { page-break-inside: avoid; }
                }
            `);
            printWindow.document.write('</style></head><body>');
            printWindow.document.write('<h1>Your Tarokka Reading</h1>');

            fortunePositions.forEach(pos => {
                const cardData = dealtCards[pos];
                if (cardData) {
                    const positionTitle = pos.charAt(0).toUpperCase() + pos.slice(1);
                    printWindow.document.write(`
                        <div class="fortune-section">
                            <h2>${positionTitle}: ${cardData.name}</h2>
                            <img src="${cardData.imageFront}" alt="${cardData.name}" class="card-image">
                            <p>${cardData.meanings[pos]}</p>
                        </div>
                    `);
                }
            });

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
            console.log('printPlayerHandout: Handout generated and print dialog opened.');
        }

        /**
         * Saves the current reading to localStorage.
         */
        function saveReading() {
            try {
                const readingToSave = {
                    dealtCards: dealtCards,
                    // Store current rigging selections as well
                    riggedSelections: fortunePositions.map(pos => ({
                        position: pos,
                        cardId: document.getElementById(`rig-${pos}`).value
                    }))
                };
                localStorage.setItem('tarokkaReading', JSON.stringify(readingToSave));
                console.log('saveReading: Reading saved to local storage.');
            } catch (e) {
                console.error("saveReading: Failed to save reading:", e);
            }
        }

        /**
         * Loads a reading from localStorage.
         */
        async function loadSavedReading() {
            console.log('loadSavedReading: Attempting to load reading from local storage.');
            try {
                const savedReading = localStorage.getItem('tarokkaReading');
                if (savedReading) {
                    const parsedReading = JSON.parse(savedReading);
                    dealtCards = parsedReading.dealtCards;
                    console.log('loadSavedReading: Parsed saved reading:', dealtCards);

                    // Ensure card data has image paths for re-creation
                    for (const pos in dealtCards) {
                        if (dealtCards[pos] && !dealtCards[pos].imageFront) {
                            const originalCard = tarokkaCards.find(c => c.id === dealtCards[pos].id);
                            if (originalCard) {
                                dealtCards[pos].imageFront = originalCard.imageFront;
                                dealtCards[pos].imageBack = originalCard.imageBack;
                            } else {
                                console.warn(`loadSavedReading: Original card data not found for ID: ${dealtCards[pos].id}`);
                                // Fallback for missing image paths if original card not found
                                dealtCards[pos].imageFront = `https://placehold.co/110x190/333333/FFFFFF?text=${dealtCards[pos].name.replace(/ /g, '+')}`;
                                dealtCards[pos].imageBack = `https://placehold.co/110x190/3A1F1F/B8860B?text=Tarokka+Back+Ornate`;
                            }
                        }
                    }

                    await dealCards(dealtCards, false); // Deal without animation, wait for images to load

                    // Update rigging dropdowns with loaded selections
                    if (parsedReading.riggedSelections) {
                        fortunePositions.forEach(pos => {
                            const selectElement = document.getElementById(`rig-${pos}`);
                            if (selectElement) {
                                const savedSelection = parsedReading.riggedSelections.find(s => s.position === pos);
                                if (savedSelection) {
                                    selectElement.value = savedSelection.cardId;
                                } else {
                                    selectElement.value = '';
                                }
                            }
                        });
                    }

                    // Re-add flipped cards to log and visually flip them
                    clearProphecyLog();
                    hideDmCardInfo(); // Clear DM info box
                    fortunePositions.forEach(pos => {
                        const cardData = dealtCards[pos];
                        if (cardData) {
                            addEntryToProphecyLog(cardData, pos);
                            const cardElement = document.querySelector(`#position-${pos} .card`);
                            if (cardElement && !cardElement.classList.contains('flipped')) {
                                cardElement.classList.add('flipped');
                                displayFortune(cardData, pos);
                                // Only display DM info box if DM panel is visible AND cast mode is NOT active
                                if (isDmPanelVisible && !isCastModeActive) {
                                    displayDmCardInfo(cardData, pos);
                                }
                            }
                        }
                    });
                    console.log('loadSavedReading: Reading successfully loaded and displayed.');
                } else {
                    console.log('loadSavedReading: No previous Tarokka reading found in local storage.');
                }
            } catch (e) {
                console.error("loadSavedReading: Failed to load reading:", e);
            }
        }

        /**
         * Clears all cards from the table with a dramatic animation.
         */
        async function clearCardsAndReading() {
            console.log('clearCardsAndReading: Clearing all cards from the table.');
            hideAllFortunes(); // Hide fortunes immediately
            clearProphecyLog(); // Clear log immediately
            hideDmCardInfo(); // Hide DM info box immediately

            const cardElements = document.querySelectorAll('.card');
            const animationPromises = [];

            cardElements.forEach(cardElement => {
                // Remove flipped class if present, so it can animate from face-down state
                cardElement.classList.remove('flipped');
                // Add clearing class for the dramatic exit animation
                cardElement.classList.add('clearing');

                animationPromises.push(new Promise(resolve => {
                    cardElement.addEventListener('transitionend', () => {
                        cardElement.remove(); // Remove from DOM after animation
                        resolve();
                    }, { once: true });
                }));
            });

            // Wait for all cards to complete their clearing animation
            await Promise.all(animationPromises);

            // Reset dealt cards and update display after animation
            dealtCards = {
                tome: null,
                holySymbol: null,
                sunsword: null,
                ally: null,
                strahd: null
            };
            updateCurrentReadingDisplay();
            console.log('clearCardsAndReading: All cards cleared.');
        }

        // Helper function to hide preloader
        function hidePreloader() {
            const preloader = document.getElementById('preloader');
            if (preloader) {
                preloader.style.opacity = '0';
                setTimeout(() => {
                    preloader.style.display = 'none';
                }, 1000);
            }
        }

        /**
         * Toggles the visibility of the DM control panel.
         */
        function toggleDmPanel() {
            isDmPanelVisible = !isDmPanelVisible;
            console.log(`toggleDmPanel: DM panel visibility toggled to ${isDmPanelVisible}`);
            if (isDmPanelVisible) {
                dmInterfaceContainer.classList.add('active');
                dmInterfaceContainer.style.pointerEvents = 'auto'; // Ensure pointer events are active
            } else {
                dmInterfaceContainer.classList.remove('active');
                dmInterfaceContainer.style.pointerEvents = 'none'; // Ensure pointer events are off
            }
            // Ensure DM info box visibility is correct based on DM panel and cast mode
            if (isDmPanelVisible && !isCastModeActive) {
                if (dmCardInfoText.innerHTML !== '') { // Only show if there's content
                    dmCardInfoBox.classList.add('active');
                }
            } else {
                dmCardInfoBox.classList.remove('active');
            }
        }

        /**
         * Toggles the "Cast to Players" mode.
         */
        function toggleCastMode() {
            isCastModeActive = !isCastModeActive;
            console.log(`toggleCastMode: Cast mode toggled to ${isCastModeActive}`);
            if (isCastModeActive) {
                // ENTER CAST MODE
                // Hide DM interface elements
                dmControlPanel.classList.add('cast-mode-hidden');
                toggleDmBtn.classList.add('cast-mode-hidden'); // The DM toggle button itself
                dmCardInfoBox.classList.remove('active'); // Hide DM info box

                // Hide the individual bottom buttons during cast mode
                castToPlayersBtn.classList.add('cast-mode-hidden');
                patreonBtn.classList.add('cast-mode-hidden');


                // Explicitly disable pointer events for the DM interface container
                dmInterfaceContainer.style.pointerEvents = 'none';

                // Show ESC indicator
                escIndicator.classList.add('active');
            } else {
                // EXIT CAST MODE
                // Show DM interface elements (if DM panel was visible)
                dmControlPanel.classList.remove('cast-mode-hidden');
                toggleDmBtn.classList.remove('cast-mode-hidden');

                // Show the individual bottom buttons when exiting cast mode
                castToPlayersBtn.classList.remove('cast-mode-hidden');
                patreonBtn.classList.remove('cast-mode-hidden');

                // Restore DM panel visibility and pointer events based on its previous state
                if (isDmPanelVisible) {
                    dmInterfaceContainer.classList.add('active');
                    dmInterfaceContainer.style.pointerEvents = 'auto';
                    if (dmCardInfoText.innerHTML !== '') { // Only show if there's content
                        dmCardInfoBox.classList.add('active');
                    }
                } else {
                    dmInterfaceContainer.classList.remove('active');
                    dmInterfaceContainer.style.pointerEvents = 'none';
                }

                // Hide ESC indicator
                escIndicator.classList.remove('active');
            }
        }

        /**
         * Toggles the background music mute state and updates the volume icon.
         */
        function toggleMusicMute() {
            console.log('toggleMusicMute: Toggling music mute.');
            if (backgroundMusic.muted) {
                backgroundMusic.muted = false;
                volumeBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                // Set slider to current volume if unmuted, or default if it was 0
                volumeSlider.value = backgroundMusic.volume === 0 ? 0.3 : backgroundMusic.volume;
                console.log('toggleMusicMute: Music unmuted.');
            } else {
                backgroundMusic.muted = true;
                volumeBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                console.log('toggleMusicMute: Music muted.');
            }
        }

        /**
         * Updates the background music volume based on the slider.
         */
        function updateMusicVolume() {
            backgroundMusic.volume = volumeSlider.value;
            // Update the mute button icon based on the new volume
            if (backgroundMusic.volume === 0) {
                backgroundMusic.muted = true;
                volumeBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            } else {
                backgroundMusic.muted = false;
                volumeBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            }
            console.log(`updateMusicVolume: Volume set to ${backgroundMusic.volume}.`);
        }

        /**
         * Plays background music.
         * Handles autoplay prevention by retrying on user interaction.
         */
        function playBackgroundMusic() {
            const audio = document.getElementById('background-music');
            
            if (!audio) {
                console.error('Audio element with id "background-music" not found');
                return;
            }
            
            // Set audio properties
            audio.volume = volumeSlider.value; // Use current slider value for volume
            audio.loop = true;
            
            // Play with user interaction handling
            const playMusicAttempt = () => {
                audio.play().then(() => {
                    console.log('playBackgroundMusic: Audio playback started successfully.');
                }).catch(error => {
                    console.warn('playBackgroundMusic: Audio play failed (likely autoplay blocked):', error);
                    console.warn('Please click anywhere on the page to start music playback.');
                    // Add a one-time listener for user interaction to try playing again
                    document.addEventListener('click', playMusicAttempt, { once: true });
                });
            };
            
            playMusicAttempt();
        }

        /**
         * Populates the music selector dropdown.
         */
        function populateMusicSelector() {
            console.log('populateMusicSelector: Populating music selector.');
            musicSelector.innerHTML = ''; // Clear existing options
            musicTracks.forEach(track => {
                const option = document.createElement('option');
                option.value = track.src;
                option.textContent = track.name;
                musicSelector.appendChild(option);
            });

            // Set initial selection to the currently playing music, or the first in the list
            const currentSrc = backgroundMusic.src.split('/').pop(); // Get just the filename
            const defaultTrack = musicTracks.find(track => track.src.includes(currentSrc));
            if (defaultTrack) {
                musicSelector.value = defaultTrack.src;
            } else if (musicTracks.length > 0) {
                musicSelector.value = musicTracks[0].src;
            }
        }

        /**
         * Changes the background music based on selection.
         * @param {Event} event - The change event from the select element.
         */
        function changeBackgroundMusic(event) {
            console.log(`changeBackgroundMusic: Changing music to ${event.target.value}`);
            backgroundMusic.src = event.target.value;
            backgroundMusic.load(); // Load the new source
            backgroundMusic.loop = true; // Ensure it loops
            backgroundMusic.volume = volumeSlider.value; // Apply current volume
            backgroundMusic.muted = volumeBtn.innerHTML.includes('volume-mute'); // Apply current mute state
            playBackgroundMusic(); // Attempt to play the new music
        }

        /**
         * Plays a card flip sound effect.
         */
        function playFlipSound() {
            const flipSound = document.getElementById('flip-sound');
            
            if (flipSound) {
                flipSound.currentTime = 0; // Reset sound to beginning
                flipSound.play().catch(error => {
                    console.log('Flip sound play failed:', error);
                });
            }
        }

        /**
         * Plays a card shuffle sound effect.
         */
        function playShuffleSound() {
            if (shuffleSound) {
                shuffleSound.currentTime = 0; // Reset sound to beginning
                shuffleSound.play().catch(error => {
                    console.log('playShuffleSound: Shuffle sound play failed:', error);
                });
            }
        }


document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOMContentLoaded: Initializing Tarokka Reading app.');
    // Initial setup for single window mode
    mainGameView.style.display = 'flex';
    cardSpreadContainer.style.display = 'grid';
    // prophecyLog.style.display = 'block'; // This is now handled by CSS directly
    fortuneDisplay.style.display = 'none'; // Still hidden until cards are flipped

    // DM interface starts hidden
    dmInterfaceContainer.classList.remove('active');
    dmInterfaceContainer.style.pointerEvents = 'none'; // Ensure it's not blocking initially
    toggleDmBtn.style.display = 'block'; // DM toggle button is always visible
    dmCardInfoBox.classList.remove('active'); // Ensure DM info box is hidden initially

    // Initialize main game functions
    initDustMotes();
    renderEmptyCardPositions();
    populateRiggingDropdowns(); // Populate dropdowns immediately
    populateMusicSelector(); // Populate music selector

    // Set default music source and attempt to play background music
    backgroundMusic.src = musicTracks[0].src;
    playBackgroundMusic(); // Call the new function for robust autoplay handling

    // Perform initial shuffle and deal
    await handleShuffleAndDeal();
    hidePreloader();

    // Button Event Listeners
    toggleDmBtn.addEventListener('click', () => {
        console.log('DM Options button clicked.');
        toggleDmPanel();
    });
    randomizeAllBtn.addEventListener('click', handleRandomizeAll);
    shuffleDealBtn.addEventListener('click', handleShuffleAndDeal);
    revealAllBtn.addEventListener('click', handleRevealAll);
    hideAllBtn.addEventListener('click', handleHideAll);
    printHandoutBtn.addEventListener('click', printPlayerHandout);
    saveReadingBtn.addEventListener('click', saveReading);
    document.getElementById('load-saved-reading-btn').addEventListener('click', loadSavedReading); // Listener for loading saved reading
    document.getElementById('clear-reading-btn').addEventListener('click', clearCardsAndReading); // Listener for clearing cards
    castToPlayersBtn.addEventListener('click', toggleCastMode);
    volumeBtn.addEventListener('click', toggleMusicMute); // Mute/unmute button listener
    volumeSlider.addEventListener('input', updateMusicVolume); // Slider input listener
    musicSelector.addEventListener('change', changeBackgroundMusic); // Music selector listener
    // Patreon button click handled by inline onclick for simplicity

    // Keyboard listener for ESC key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && isCastModeActive) {
            console.log('ESC key pressed in Cast Mode. Exiting Cast Mode.');
            toggleCastMode(); // Exit cast mode
        }
    });

    // Declare cardMoveX and cardMoveY in a scope accessible by createCardElement and mousemove listener
    let cardMoveX = 0;
    let cardMoveY = 0;

    // Parallax effect (modified to only affect background)
    document.addEventListener('mousemove', (e) => {
        const x = (e.clientX / window.innerWidth - 0.5) * 2;
        const y = (e.clientY / window.innerHeight - 0.5) * 2;

        const bgMoveX = x * 15;
        const bgMoveY = y * 15;
        backgroundTable.style.transform = `translate(${bgMoveX}px, ${bgMoveY}px) translateZ(-100px)`;

        // Update cardMoveX and cardMoveY for card parallax
        cardMoveX = x * 5;
        cardMoveY = y * 5;

        // Apply card parallax to all cards if not flipped
        document.querySelectorAll('.card').forEach(cardElement => {
            if (!cardElement.classList.contains('flipped')) {
                cardElement.style.transform = `translate(${cardMoveX}px, ${cardMoveY}px)`;
            } else {
                // If flipped, maintain the flipped state and apply parallax
                cardElement.style.transform = `translate(${cardMoveX}px, ${cardMoveY}px) rotateY(180deg) scale(1.05)`;
            }
        });
    });

    // Candle flicker effect
    function flickerCandle() {
        const intensity = Math.random() * 0.1 + 0.9;
        const spread = Math.random() * 20 + 40;
        const colorAlpha = 0.4 + (Math.random() * 0.2);
        candleLightSource.style.boxShadow = `0 0 ${spread}px rgba(255, 165, 0, ${colorAlpha})`;
        setTimeout(flickerCandle, Math.random() * 200 + 50);
    }
    flickerCandle();
});

    </script>
</body>
</html>
